{% extends 'base.html' %}

{% block title %}Profile for {{ profile_user.username }} - CarHub{% endblock %}

{% block content %}
    <!-- Profile Card -->
    <div class="max-w-4xl mx-auto bg-white p-8 rounded-xl shadow-lg mb-12">
        <div class="flex flex-col sm:flex-row items-center sm:space-x-8">
            <!-- Profile Picture -->
            <div class="flex-shrink-0 mb-6 sm:mb-0">
                <!-- We now use the user's profile image -->
                <img class="w-32 h-32 rounded-full object-cover" src="{{ profile_user.profile.image.url }}" alt="Profile picture for {{ profile_user.username }}">
            </div>
            <!-- User Info -->
            <div class="text-center sm:text-left">
                <h1 class="text-4xl font-bold text-black">{{ profile_user.username }}</h1>
                {% if profile_user.first_name and profile_user.last_name %}
                    <p class="text-lg text-gray-600">{{ profile_user.first_name }} {{ profile_user.last_name }}</p>
                {% endif %}
                <p class="text-gray-500 mt-1">{{ profile_user.email }}</p>
                <p class="text-sm text-gray-500 mt-2">Member since: {{ profile_user.date_joined|date:"F Y" }}</p>
                
                <!-- Average Rating -->
                <div class="mt-4 flex items-center justify-center sm:justify-start">
                    {% if average_rating %}
                        <div class="flex items-center">
                            {% for i in "12345" %}
                                <svg class="w-6 h-6 {% if forloop.counter <= average_rating|floatformat:0 %} text-yellow-400 {% else %} text-gray-300 {% endif %}" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>
                            {% endfor %}
                        </div>
                        <span class="ml-2 text-gray-600 font-semibold">{{ average_rating|floatformat:1 }} out of 5</span>
                    {% else %}
                        <span class="text-gray-500">No reviews yet</span>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Action Buttons (only show if viewing your own profile) -->
        {% if user == profile_user %}
        <div class="mt-8 border-t border-gray-200 pt-6 grid grid-cols-1 sm:grid-cols-2 gap-4">
            <a href="{% url 'edit-profile' %}" class="bg-gray-200 text-black font-bold py-3 px-4 rounded-lg hover:bg-gray-300 transition-colors duration-300 text-center">
                Edit Profile
            </a>
            <a href="{% url 'password_change' %}" class="bg-gray-200 text-black font-bold py-3 px-4 rounded-lg hover:bg-gray-300 transition-colors duration-300 text-center">
                Change Password
            </a>
        </div>
        {% endif %}
    </div>

    <!-- Reviews Section -->
    <div class="max-w-4xl mx-auto">
        <h2 class="text-3xl font-bold text-black mb-6">Feedback & Reviews ({{ reviews|length }})</h2>
        <div class="space-y-6">
            {% for review in reviews %}
            <div class="bg-white p-6 rounded-lg shadow-md">
                <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center">
                        <!-- Show reviewer's profile pic -->
                        <img class="w-10 h-10 rounded-full object-cover" src="{{ review.reviewer.profile.image.url }}" alt="Profile picture for {{ review.reviewer.username }}">
                        <a href="{% url 'profile' username=review.reviewer.username %}" class="ml-3 font-semibold hover:underline">{{ review.reviewer.username }}</a>
                    </div>
                    <span class="text-sm text-gray-500">{{ review.timestamp|date:"d M Y" }}</span>
                </div>
                <div class="flex items-center my-2">
                    {% for i in "12345" %}
                        <svg class="w-5 h-5 {% if forloop.counter <= review.rating %} text-yellow-400 {% else %} text-gray-300 {% endif %}" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>
                    {% endfor %}
                </div>
                <p class="text-gray-700">{{ review.comment }}</p>
				{% if review.seller_response %}
    <div class="mt-4 ml-8 bg-gray-100 p-4 rounded-md border-l-4 border-red-200">
        <p class="text-sm font-semibold text-gray-800">Response from {{ review.seller.username }}:</p>
        <p class="text-gray-700 mt-1">{{ review.seller_response }}</p>
    </div>
{% elif user == profile_user %}
    <div class="mt-3 text-right">
        <a href="{% url 'add-review-response' review.id %}" class="inline-block bg-gray-200 text-black text-xs font-bold py-1 px-3 rounded-lg hover:bg-gray-300 transition-colors">
            Add Response
        </a>
    </div>
{% endif %}
            </div>
            {% empty %}
            <div class="bg-white p-6 rounded-lg shadow-md text-center">
                <p class="text-gray-500">This user has not received any reviews yet.</p>
            </div>
            {% endfor %}
        </div>
    </div>
{% endblock %}
