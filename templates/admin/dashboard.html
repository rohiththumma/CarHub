<!-- File: templates/admin/dashboard.html -->

{% extends "admin/base_site.html" %}
{% block title %}Dashboard | CarHub Admin{% endblock %}

{% block branding %}
<h1 id="site-name"><a href="{% url 'admin:index' %}">ðŸš— CarHub Administration</a></h1>
{% endblock %}

{% block content %}
<div id="content-main">
    <!-- METRIC CARDS -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
        <div style="background: #fff; padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h2 style="font-size: 1.5rem; font-weight: bold; color: #333;">{{ total_users }}</h2>
            <p style="color: #666;">Total Users</p>
        </div>
        <div style="background: #fff; padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h2 style="font-size: 1.5rem; font-weight: bold; color: #333;">{{ total_listings }}</h2>
            <p style="color: #666;">Total Listings</p>
        </div>
        <div style="background: #fff; padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h2 style="font-size: 1.5rem; font-weight: bold; color: #10B981;">{{ active_listings }}</h2>
            <p style="color: #666;">Active Listings</p>
        </div>
        <div style="background: #fff; padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h2 style="font-size: 1.5rem; font-weight: bold; color: #EF4444;">{{ sold_listings }}</h2>
            <p style="color: #666;">Cars Sold</p>
        </div>
    </div>

    <!-- CHARTS -->
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 2rem;">
        <div style="background: #fff; padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h3 style="font-weight: bold; margin-bottom: 1rem;">Listings by Brand</h3>
            <canvas id="brandChart"></canvas>
        </div>
        <div style="background: #fff; padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h3 style="font-weight: bold; margin-bottom: 1rem;">Listings by Status</h3>
            <canvas id="statusChart"></canvas>
        </div>
    </div>
	
	<div style="background: #fff; padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-top: 1.5rem;">
    <h3 style="font-weight: bold; margin-bottom: 1rem;">Recent Activity</h3>
    <ul style="list-style: none; padding: 0; margin: 0; max-height: 400px; overflow-y: auto;">
    {% for item in activity_feed %}
        <li style="display: flex; align-items: center; padding: 0.75rem 0; border-bottom: 1px solid #f0f0f0;">
            <!-- Icon -->
            <div style="margin-right: 1rem; color: #555;">
                {% if item.activity_type == 'User' %}
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                {% elif item.activity_type == 'Listing' %}
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 16.5V18a2 2 0 0 1-2 2h-4a2 2 0 0 1-2-2v-1.5"></path><path d="M18 12h.01"></path><path d="M6 12h.01"></path><path d="M12 12h.01"></path><path d="M12 8.5V12"></path><path d="M7 19h10"></path><path d="M17 16.5c.33-.2.67-.33 1-.5 1.5-.66 2.5-2.16 2.5-3.5C20.5 9 18 7 15 7s-5.5 2-5.5 5c0 1.34 1 2.84 2.5 3.5.33.17.67.3 1 .5"></path></svg>
                {% elif item.activity_type == 'Review' %}
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>
                {% endif %}
            </div>
            <!-- Activity Text (takes full width now) -->
            <div style="flex-grow: 1; color: #333;">
                {% if item.activity_type == 'User' %}
                    User <a href="{% url 'admin:auth_user_change' item.id %}" style="color: #007bff; text-decoration: none;"><strong>{{ item.username }}</strong></a> just signed up.
                {% elif item.activity_type == 'Listing' %}
                    A new listing <a href="{% url 'admin:listings_carlisting_change' item.id %}" style="color: #007bff; text-decoration: none;"><strong>{{ item }}</strong></a> was posted by {{ item.seller.username }}.
                {% elif item.activity_type == 'Review' %}
                    A new review was left for <a href="{% url 'admin:auth_user_change' item.seller.id %}" style="color: #007bff; text-decoration: none;"><strong>{{ item.seller.username }}</strong></a> by {{ item.reviewer.username }}.
                {% endif %}
            </div>
            <!-- The timestamp div has been completely removed -->
        </li>
    {% empty %}
        <li style="padding: 1rem; text-align: center; color: #666;">No recent activity.</li>
    {% endfor %}
</ul>
    </ul>
    </div>

    <!-- This loads the Chart.js library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Safely pass Django data to JavaScript using the json_script tag -->
    {{ brand_labels|json_script:"brand-labels" }}
    {{ brand_data|json_script:"brand-data" }}
    {{ status_labels|json_script:"status-labels" }}
    {{ status_data|json_script:"status-data" }}

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Helper function to safely retrieve and parse data
            const getChartData = (id) => {
                const element = document.getElementById(id);
                // If the element doesn't exist (because the data was empty), return an empty array
                if (!element) {
                    return [];
                }
                return JSON.parse(element.textContent);
            };

            // Retrieve and parse the data safely
            const brandLabels = getChartData('brand-labels');
            const brandData = getChartData('brand-data');
            const statusLabels = getChartData('status-labels');
            const statusData = getChartData('status-data');

            // Data for Brand Chart (Bar Chart)
            const brandCtx = document.getElementById('brandChart').getContext('2d');
            new Chart(brandCtx, {
                type: 'bar',
                data: {
                    labels: brandLabels,
                    datasets: [{
                        label: '# of Listings',
                        data: brandData,
                        backgroundColor: 'rgba(239, 68, 68, 0.7)',
                        borderColor: 'rgba(239, 68, 68, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    },
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });

            // Data for Status Chart (Doughnut Chart)
            const statusCtx = document.getElementById('statusChart').getContext('2d');
            new Chart(statusCtx, {
                type: 'doughnut',
                data: {
                    labels: statusLabels,
                    datasets: [{
                        label: 'Listing Status',
                        data: statusData,
                        backgroundColor: [
                            'rgba(251, 191, 36, 0.7)', // Pending
                            'rgba(16, 185, 129, 0.7)', // Active
                            'rgba(156, 163, 175, 0.7)', // Sold
                            'rgba(239, 68, 68, 0.7)',  // Rejected
                        ],
                        borderColor: [
                            'rgba(251, 191, 36, 1)',
                            'rgba(16, 185, 129, 1)',
                            'rgba(156, 163, 175, 1)',
                            'rgba(239, 68, 68, 1)',
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    }
                }
            });
        });
    </script>
</div>
{% endblock %}
